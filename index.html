<!DOCTYPE html>
<html lang="en">

<head>

	<link rel="stylesheet" href="StyleSheet.css" type="text/css"/>
	<link rel="stylesheet" href="modalStyle.css" type="text/css"/>
	<title>PML IDE</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="http://danml.com/js/download.js"></script>
	<script type="text/javascript">
		/* Taken from http://www.sitepoint.com/how-to-deal-with-cookies-in-javascript/ */
		function getCookie(name) {
			var regexp = new RegExp("(?:^" + name + "|;\s*"+ name + ")=(.*?)(?:;|$)", "g");
			var result = regexp.exec(document.cookie);
			return (result === null) ? null : result[1];
		}

		function logout() {
			// Clear the cookie by settings its expiry date to the past.
			document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/";
			// Reload the page.
			window.location.href = "index.html";
		}

		function readFile(evt) {
			var files = evt.target.files;
			if (files) {
				var file = files[0]; // Only consider the first file.
				var reader = new FileReader();
				reader.onload = (
					function (file) {
						return function (e) {
							editor.setValue(e.target.result);
						};
					}
				)(file);
				reader.readAsText(file);
			} else {
				alert('No file!');
			}
		}

		window.onload = function onload() {
			var username = getCookie("username");
			if (username) {
				document.getElementById("login_button").innerHTML = "<a href='javascript: void(0)'>" + username + "</a>";
				document.getElementById("login_button").insertAdjacentHTML("beforebegin", '<a class="alignright href="index.html" onclick="logout()">Log out</a>');
			} else {
			}
			document.getElementById('fileInput').addEventListener('change', readFile, false);
		}
	</script>
</head>

<body>

	<script>
		function check() {
			$.post(
				"check.php",
				{value: editor.getSession().getValue()},
				function(data, status) {
					alert(data);
				});
		}

		function download_file() {
			download(editor.getValue(), 'file.pml', 'text/plain');
		}

		function login() {
			var email = document.getElementById("mail").value;
			var password = document.getElementById("password").value;
			$.post(
				"login.php",
				{email: email, password: password},
				function(response) {
					var str0 = "Success!"; // This doesn't have a NULL-terminator.
					var str1 = response.substring(0, response.length - 1); // The response has a NULL-terminator.
					// The NULL-terminator affects the comparison.
					if (str0 == str1) {
						// Login succeeded.
						var cookie0 = "username=";
						var cookie1 = cookie0 + email + ";path=/;";
						document.cookie = cookie1;
						document.location.href = "index.html";
					} else {
						// Login did not succeed.
						alert("Login unsuccessful.");
					}
				});
		}

		function register() {
			var emailAddress = document.getElementById("mail").value;
			var password = document.getElementById("password").value;
			$.post(
				"register.php",
				{email: emailAddress, password: password},
				function(response) {
					alert(response);
					if (response.substring(0, 5) == "A new") {
						switchDialogContents("login");
						//document.location.href = "login.html";
					}
				});
		}

		function switchDialogContents(type) {
			if (type == "register") {
				document.getElementById("dialogContents").innerHTML = "<a href='#close' title='Close' class='close'>X</a><h1>Register</h1><label for='mail'>Email:</label></br><input type='email' id='mail'></br><label for='password'>Password:</label></br><input type='password' id='password'></br><button type='submit' onclick='register()'>Register</button>";
			} else if (type == "login") {
				document.getElementById("dialogContents").innerHTML = "<a href='#close' title='Close' class='close'>X</a><h1>Log In</h1><label for='mail'>Email:</label></br><input type='email' id='mail'></br><label for='password'>Password:</label></br><input type='password' id='password'></br><button type='submit' onclick='login()'>Log In</button>";

			}
		}
	</script>

	<div id="navigation">
	<a class="alignright" id="login_button" href="#openModal">Log In</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="error_annot(editor)">Check PML</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="ace_edit(editor)">Ace</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="vim(editor)">Vim</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="emac(editor)">Emacs</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="download_file()">Download</a>
	<input class="alignleft" type="file" id="fileInput" multiple/>
	</div>
	<div style="clear: both;"></div>

	<div id="openModal" class="modalDialog">
	<div id="dialogContents">
		<a href="#close" title="Close" class="close">X</a>
		<h1>Log in</h1>
		<label for="mail">Email:</label></br>
		<input type="email" id="mail"></br>
		<label for="password">Password:</label></br>
		<input type="password" id="password"></br>
		<button type="submit" onclick="login()">Log in</button></br>
		<a href="javascript: void(0)" onclick="switchDialogContents('register');">Don't have an account?</a>
	</div>
	</div>

	<div id="editor">process Diabetes_assessment {
        action Assess_patient_symptoms {
                requires {patient_symptoms}
                provides {assessment.suspect_diabetes}
        }
        branch {
                action Glucose_test {
                        requires {assessment.suspect_diabetes}
                        provides {blood_test.glucose_test}
                }
                action Cholesterol_test {
                        requires {assessment.suspect_diabetes}
                        provides {blood_test.cholesterol_test}
                }
        }
        action Assess_diabetes {
                requires {blood_test.glucose_test && (optional) blood_test.cholesterol_test}
                provides {diagnosis.diabetes}
        }
}
        </div>
    
	<script src="./thirdparty/ace/src/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="http://ajaxorg.github.io/ace-builds/src/ext-language_tools.js"></script>
	<script>
    		var editor = ace.edit("editor");
		editor.getSession().setUseWorker(false);
    		editor.setTheme("ace/theme/monokai");
    		editor.getSession().setMode("ace/mode/pml");
		AutoComplete(editor);

		function AutoComplete(editor)
		{//For code completion
		//Takes advantage of the open source library; ajaxorg.github.io
			//Tell the editor to use it's autocompletion function
			editor.setOptions({
				enableBasicAutocompletion: true,
				enableSnippets: true,
				enableLiveAutocompletion: false
			});

			//PML keywords. Score (equal) given to likihood of being used.
			editor.completers.push({
			getCompletions: function (editor, session, pos, prefix, callback){
				callback(null, [
					{value: "process", score: 1000, meta: "keyword"},
					{value: "action", score: 1000, meta: "keyword"},
					{value: "branch", score: 1000, meta: "keyword"},
					{value: "requires", score: 1000, meta: "keyword"},
					{value: "provides", score: 1000, meta: "keyword"},
					{value: "selection", score: 1000, meta: "keyword"},
					{value: "agent", score: 1000, meta: "keyword"},
					{value: "script", score: 1000, meta: "keyword"},
					{value: "iteration", score: 1000, meta: "keyword"},
					{value: "sequence", score: 1000, meta: "keyword"}
				]);
			}});

			//Make sure the Autocompletion is called when user is typing
			editor.commands.on("afterExec", function(e){
				if(e.command.name == "insertstring"&&/^[\w.]$/.test(e.args))
				{
					editor.execCommand("startAutocomplete");
				}
			});
		}

		function error_annot(editor){
			var arrayOfAnnos = [];
                        $.post(
                                "check.php",
                                {value: editor.getSession().getValue()},
                                function(data, status) {
				var arrr = data.split("/tmp/");
				for(var i=1; i< arrr.length; i++){
					var start_pos = arrr[i].indexOf(':') + 1;
					var end_pos = arrr[i].indexOf(':',start_pos);
					var text_to_get = arrr[i].substring(start_pos,end_pos)

					var error_text = arrr[i].split(":").pop().split(";").shift();
					var arrStr = arrr[i].split(/[:]/);

						var gutterAnno = {
						row: text_to_get-1,	
						column: 10,
						text: error_text,
						type: "error"
						}
					arrayOfAnnos.push(gutterAnno);
				}
					editor.getSession().setAnnotations(arrayOfAnnos);				 							
                                });
		}
		function ace_edit(editor)
		{
			editor.setKeyboardHandler();
		}

		function vim(editor)
		{
			editor.setKeyboardHandler("ace/keyboard/vim");
		}
		
		function emac(editor)
		{
			editor.setKeyboardHandler("ace/keyboard/emacs");
		}

	</script>

</body>
</html>
