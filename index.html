<!DOCTYPE html>
<html lang="en">

<head>

	<link rel="stylesheet" href="StyleSheet.css" type="text/css"/>
	<title>PML IDE</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="http://danml.com/js/download.js"></script>
	<script type="text/javascript">
		/* Taken from http://www.sitepoint.com/how-to-deal-with-cookies-in-javascript/ */
		function getCookie(name) {
			var regexp = new RegExp("(?:^" + name + "|;\s*"+ name + ")=(.*?)(?:;|$)", "g");
			var result = regexp.exec(document.cookie);
			return (result === null) ? null : result[1];
		}

		function logout() {
			// Clear the cookie by settings its expiry date to the past.
			document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/";
			// Reload the page.
			window.location.href = "index.html";
		}

		function readFile(evt) {
			var files = evt.target.files;
			if (files) {
				var file = files[0]; // Only consider the first file.
				var reader = new FileReader();
				reader.onload = (
					function (file) {
						return function (e) {
							editor.setValue(e.target.result);
						};
					}
				)(file);
				reader.readAsText(file);
			} else {
				alert('No file!');
			}
		}

		window.onload = function onload() {
			var username = getCookie("username");
			if (username) {
				document.getElementById("login_button").innerHTML = "<a href='javascript: void(0)'>" + username + "</a>";
				document.getElementById("login_button").insertAdjacentHTML("beforebegin", '<a class="alignright href="index.html" onclick="logout()">Log out</a>');
			} else {
			}
			document.getElementById('fileInput').addEventListener('change', readFile, false);
		}
	</script>
</head>

<body>

	<script>
		function check() {
			$.post(
				"check.php",
				{value: editor.getSession().getValue()},
				function(data, status) {
					alert(data);
				});
		}

		function download_file() {
			download(editor.getValue(), 'file.pml', 'text/plain');
		}
	</script>

	<div id="navigation">
	<a class="alignright" href="login.html" id="login_button">Log in</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="error_annot(editor)">Check PML</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="ace_edit(editor)">Ace</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="vim(editor)">Vim</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="emac(editor)">Emacs</a>
	<a class="alignleft" href="javascript: void(0)" id="button" onclick="download_file()">Download</a>
	<input class="alignleft" type="file" id="fileInput" multiple/>
	</div>
	<div style="clear: both;"></div>

	<div id="editor">process Diabetes_assessment {
        action Assess_patient_symptoms {
                requires {patient_symptoms}
                provides {assessment.suspect_diabetes}
        }
        branch {
                action Glucose_test {
                        requires {assessment.suspect_diabetes}
                        provides {blood_test.glucose_test}
                }
                action Cholesterol_test {
                        requires {assessment.suspect_diabetes}
                        provides {blood_test.cholesterol_test}
                }
        }
        action Assess_diabetes {
                requires {blood_test.glucose_test && (optional) blood_test.cholesterol_test}
                provides {diagnosis.diabetes}
        }
}
        </div>
    
	<script src="./thirdparty/ace/src/ace.js" type="text/javascript" charset="utf-8"></script>
	<script>
    		var editor = ace.edit("editor");
		editor.getSession().setUseWorker(false);
    		editor.setTheme("ace/theme/monokai");
    		editor.getSession().setMode("ace/mode/pml");
		
		function error_annot(editor){
			var arrayOfAnnos = [];
                        $.post(
                                "check.php",
                                {value: editor.getSession().getValue()},
                                function(data, status) {
				var arrr = data.split("/tmp/");
				for(var i=1; i< arrr.length; i++){
					var start_pos = arrr[i].indexOf(':') + 1;
					var end_pos = arrr[i].indexOf(':',start_pos);
					var text_to_get = arrr[i].substring(start_pos,end_pos)

					var error_text = arrr[i].split(":").pop().split(";").shift();
					var arrStr = arrr[i].split(/[:]/);

						var gutterAnno = {
						row: text_to_get-1,	
						column: 10,
						text: error_text,
						type: "error"
						}
					arrayOfAnnos.push(gutterAnno);
				}
					editor.getSession().setAnnotations(arrayOfAnnos);				 							
                                });
		}
		function ace_edit(editor)
		{
			editor.setKeyboardHandler();
		}

		function vim(editor)
		{
			editor.setKeyboardHandler("ace/keyboard/vim");
		}
		
		function emac(editor)
		{
			editor.setKeyboardHandler("ace/keyboard/emacs");
		}

	</script>

</body>
</html>
